import{s as m,a as x,j as N}from"./manager-dashboard-BkEir6jh.js";import{r as u}from"./react-vendor-z5qVsTvS.js";async function O(a,e){try{if(console.log("üîê API: Authenticating user:",{firstName:a,phoneNumber:e}),console.log("üîë API: Supabase client available:",m?"‚úÖ Yes":"‚ùå No"),!m)return console.error("‚ùå API: Supabase client is not initialized"),{success:!1,error:"Database connection error. Please try again later."};if(!a||!e)return{success:!1,error:"First name and phone number are required"};const o=a.trim(),p=e.trim();console.log("üîê API: Normalized inputs:",{firstName:o,phone:p}),console.log(`üîç API: Executing query: .from('unified_users').select('*').ilike('name', '${o}%').eq('status', 'active')`);let c;try{const{data:d,error:h}=await m.from("unified_users").select("*").ilike("name",`${o}%`).eq("status","active");if(h)return console.error("‚ùå API: Database search error:",h),{success:!1,error:"Database error occurred during authentication"};c=d,console.log(`üîç API: Query returned ${(c==null?void 0:c.length)||0} users`),c&&console.log("üîç API: User IDs returned:",c.map(f=>f.id).join(", "))}catch(d){return console.error("‚ùå API: Error executing query:",d),{success:!1,error:"Database error occurred during authentication"}}if(!c||c.length===0)return console.log("‚ùå API: No users found matching pattern:",o),{success:!1,error:`No user found with name starting with "${o}". Please check your spelling and try again.`};console.log("üîç API: Looking for exact first name match...");let r=c.find(d=>{const h=d.name.split(" ")[0].toLowerCase(),f=o.toLowerCase(),y=h===f;return console.log(`üîç API: Comparing '${h}' with '${f}' = ${y}`),y});if(r||(console.log("üîç API: No exact match found, trying partial match..."),r=c.find(d=>{const h=d.name.toLowerCase(),f=o.toLowerCase(),y=h.startsWith(f);return console.log(`üîç API: Partial comparing '${h}' with '${f}' = ${y}`),y})),!r)return console.log("‚ùå API: No matching user found"),{success:!1,error:`No user found matching "${o}". Please try your exact first name as shown in your profile (e.g., "John" for "John SEO").`};console.log("‚úÖ API: Found matching user:",r.name);const b=E(r.phone),_=E(p);if(console.log("üîç API: Phone validation:",{original:{user:r.phone,input:p},normalized:{user:b,input:_},match:b===_}),b!==_)return console.log("‚ùå API: Phone number mismatch:",{expected:b,provided:_}),{success:!1,error:"Incorrect phone number. Please try again."};console.log("‚úÖ API: Phone number validated successfully"),console.log("üîç API: Generating session token...");const I=F(r.id),A=new Date(Date.now()+24*60*60*1e3),w={sessionId:I,userId:r.id,expiresAt:A.toISOString(),createdAt:new Date().toISOString()};console.log("üîç API: Session data created");try{console.log("üîç API: Storing session in database..."),await m.from("user_sessions").insert({user_id:r.id,session_token:I,expires_at:A.toISOString()}),console.log("‚úÖ API: Session stored in database")}catch(d){console.warn("‚ö†Ô∏è API: Could not store session in database:",d)}const P={id:r.id,name:r.name,firstName:r.name.split(" ")[0],phone:r.phone,email:r.email,role:r.role,user_category:r.user_category,department:r.department,permissions:r.permissions||{},dashboard_access:r.dashboard_access||[]};return console.log("‚úÖ API: Authentication successful for:",r.name),{success:!0,user:P,token:I,sessionData:w}}catch(o){return console.error("‚ùå API: Authentication error:",o),{success:!1,error:"An unexpected error occurred during authentication"}}}function E(a){return a?a.replace(/^\+91-?/,"").replace(/[\s\-\(\)]/g,"").replace(/^0/,""):""}function F(a){const e=Date.now(),o=Math.random().toString(36).substring(2);return`${a}_${e}_${o}`}function $(a){return{"Super Admin":"/super-admin","Operations Head":"/admin",Manager:"/admin",HR:"/admin",Accountant:"/admin",Sales:"/admin",SEO:"/employee",Ads:"/employee","Social Media":"/employee","YouTube SEO":"/employee","Web Developer":"/employee","Graphic Designer":"/employee",Freelancer:"/employee",Intern:"/employee",Client:"/client"}[a]||"/dashboard"}async function q(a){try{if(!a)return{valid:!1,error:"No token provided"};const[e]=a.split("_"),{data:o,error:p}=await m.from("user_sessions").select("*").eq("session_token",a).eq("user_id",e).single();return p||!o?{valid:!1,error:"Invalid session"}:new Date(o.expires_at)<new Date?(await m.from("user_sessions").delete().eq("session_token",a),{valid:!1,error:"Session expired"}):{valid:!0,session:o}}catch(e){return console.error("Session validation error:",e),{valid:!1,error:"Session validation failed"}}}async function M(a){try{return a&&await m.from("user_sessions").delete().eq("session_token",a),typeof window<"u"&&(localStorage.removeItem("unified_auth_session"),localStorage.removeItem("unified_auth_user"),localStorage.removeItem("unified_auth_local_user")),{success:!0}}catch(e){return console.error("Logout error:",e),{success:!1,error:"Logout failed"}}}const v=u.createContext(null),T=()=>{const a=u.useContext(v);if(!a)throw new Error("useUnifiedAuth must be used within a UnifiedAuthProvider");return a},S={SEO:{category:"employee",department:"Marketing",dashboards:["seo_dashboard","employee_dashboard","profile"]},Ads:{category:"employee",department:"Marketing",dashboards:["ads_dashboard","employee_dashboard","profile"]},"Social Media":{category:"employee",department:"Marketing",dashboards:["social_dashboard","employee_dashboard","profile"]},"YouTube SEO":{category:"employee",department:"Marketing",dashboards:["youtube_dashboard","employee_dashboard","profile"]},"Web Developer":{category:"employee",department:"Technology",dashboards:["dev_dashboard","employee_dashboard","profile"]},"Graphic Designer":{category:"employee",department:"Creative",dashboards:["design_dashboard","employee_dashboard","profile"]},Freelancer:{category:"freelancer",department:null,dashboards:["freelancer_dashboard","profile"]},Intern:{category:"intern",department:null,dashboards:["intern_dashboard","profile"]},"Operations Head":{category:"management",department:"Operations",dashboards:["operations_dashboard","management_dashboard","profile"]},Accountant:{category:"admin",department:"Finance",dashboards:["accounting_dashboard","admin_dashboard","profile"]},Sales:{category:"admin",department:"Sales",dashboards:["sales_dashboard","admin_dashboard","profile"]},HR:{category:"admin",department:"Human Resources",dashboards:["hr_dashboard","admin_dashboard","profile"]},"Super Admin":{category:"super_admin",department:"Administration",dashboards:["super_admin_dashboard","all_dashboards","profile"]}},z=({children:a})=>{const[e,o]=u.useState({isLoggedIn:!1,user:null,role:null,userCategory:null,permissions:{},dashboardAccess:[],sessionId:null,isLoading:!1,loginError:null}),[p,c]=u.useState({firstName:"",phone:""}),{notify:r}=x();u.useEffect(()=>{(async()=>{try{const i=localStorage.getItem("unified_auth_session"),t=localStorage.getItem("unified_auth_user");if(!i||!t){console.log("üîç No saved session found");return}const s=JSON.parse(i),l=JSON.parse(t),g=s.sessionId;console.log("üîÑ Attempting to restore session:",{userId:l.id,sessionId:(g==null?void 0:g.substring(0,10))+"..."});const{valid:k,error:D}=await q(g);if(!k){console.log("‚ùå Session invalid or expired:",D),localStorage.removeItem("unified_auth_session"),localStorage.removeItem("unified_auth_user");return}console.log("‚úÖ Session restored successfully");const L=S[l.role];o({isLoggedIn:!0,user:l,role:l.role,userCategory:l.user_category,permissions:l.permissions||{},dashboardAccess:l.dashboard_access||(L==null?void 0:L.dashboards)||[],sessionId:g,isLoading:!1,loginError:null})}catch(i){console.error("Error restoring session:",i),localStorage.removeItem("unified_auth_session"),localStorage.removeItem("unified_auth_user")}})()},[]);const b=u.useCallback(async n=>{const{firstName:i,phone:t}=n;if(!i||!t){const s="First name and phone number are required";throw o(l=>({...l,loginError:s,isLoading:!1})),new Error(s)}o(s=>({...s,isLoading:!0,loginError:null}));try{console.log("üîê Authenticating user with first name and phone");const s=await O(i,t);if(!s.success)throw new Error(s.error);console.log("‚úÖ Authentication successful for:",s.user.name);const l=s.sessionData||{sessionId:s.token,userId:s.user.id,expiresAt:new Date(Date.now()+24*60*60*1e3).toISOString()};localStorage.setItem("unified_auth_session",JSON.stringify(l)),localStorage.setItem("unified_auth_user",JSON.stringify(s.user));const g=S[s.user.role];return o({isLoggedIn:!0,user:s.user,role:s.user.role,userCategory:s.user.user_category,permissions:s.user.permissions||{},dashboardAccess:s.user.dashboard_access||(g==null?void 0:g.dashboards)||[],sessionId:s.token,isLoading:!1,loginError:null}),r({type:"success",title:"Login Successful",message:`Welcome back, ${s.user.firstName}!`}),{success:!0,user:s.user,dashboardRoute:$(s.user.role)}}catch(s){console.error("‚ùå Login failed:",s);const l=s.message||"Login failed. Please check your credentials.";throw o(g=>({...g,loginError:l,isLoading:!1})),r({type:"error",title:"Login Failed",message:l}),s}},[r]),_=u.useCallback(async()=>{console.log("üö™ Logging out user");try{await M(e.sessionId),o({isLoggedIn:!1,user:null,role:null,userCategory:null,permissions:{},dashboardAccess:[],sessionId:null,isLoading:!1,loginError:null}),r({type:"success",title:"Logged out successfully",message:"You have been logged out safely"})}catch(n){console.error("Logout error:",n),r({type:"error",title:"Logout Error",message:"There was an issue logging out"})}},[e.sessionId,r]),I=u.useCallback(n=>{c(i=>({...i,...n}))},[]),A=u.useCallback(()=>{o(n=>({...n,loginError:null}))},[]),w=u.useCallback((n,i)=>{if(!e.isLoggedIn||!e.role)return!1;if(e.role==="Super Admin")return!0;switch(e.userCategory){case"super_admin":return!0;case"management":case"admin":return["read","write","approve"].includes(i);case"employee":case"freelancer":case"intern":return["read","write"].includes(i)&&!n.includes("admin");default:return!1}},[e.isLoggedIn,e.role,e.userCategory]),P=u.useCallback(n=>e.isLoggedIn?e.role==="Super Admin"?!0:e.dashboardAccess.includes(n):!1,[e.isLoggedIn,e.role,e.dashboardAccess]),d=u.useCallback(async()=>{if(!e.isLoggedIn||!e.user)return!1;try{const n=new Date().toISOString().slice(0,7)+"-01",{data:i,error:t}=await m.from("monthly_form_submissions").select("id").eq("user_id",e.user.id).eq("submission_month",n).limit(1);return t?(console.error("Error checking monthly form submission:",t),!1):i.length===0}catch(n){return console.error("Error checking monthly form submission:",n),!1}},[e.isLoggedIn,e.user]),h=u.useCallback(()=>Object.keys(S).sort(),[]),f=u.useCallback(n=>S[n]||null,[]),y=u.useCallback(async n=>{var i;try{if(!e.isLoggedIn||!((i=e.user)!=null&&i.id))throw new Error("User not authenticated");if(m){const{data:t,error:s}=await m.from("unified_users").update({...n,updated_at:new Date().toISOString()}).eq("id",e.user.id).select().single();if(s)throw s;return o(l=>({...l,user:{...l.user,...n}})),r({type:"success",title:"Profile Updated",message:"Your profile has been updated successfully."}),{success:!0,data:t}}else return o(t=>({...t,user:{...t.user,...n}})),r({type:"success",title:"Profile Updated",message:"Your profile has been updated successfully. (Testing Mode)"}),{success:!0}}catch(t){return console.error("Error updating profile:",t),r({type:"error",title:"Update Failed",message:t.message||"Failed to update profile."}),{success:!1,error:t.message}}},[e.isLoggedIn,e.user,m,r]),C={authState:e,isLoggedIn:e.isLoggedIn,user:e.user,role:e.role,userCategory:e.userCategory,permissions:e.permissions,dashboardAccess:e.dashboardAccess,isLoading:e.isLoading,loginError:e.loginError,loginForm:p,updateLoginForm:I,login:b,logout:_,updateProfile:y,clearLoginError:A,hasPermission:w,hasDashboardAccess:P,needsMonthlyFormSubmission:d,getAvailableRoles:h,getRoleConfig:f,PREDEFINED_ROLES:S};return N.jsx(v.Provider,{value:C,children:a})};export{z as U,T as u};
