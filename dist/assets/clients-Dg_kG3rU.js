import{d as q,c as X,j as e,e as L,g as O,u as Z,b as ee,I as te,J as U,S as W,M as se,N as ae}from"./manager-dashboard-BSBEKJka.js";import{r as c,R as ne}from"./react-vendor-z5qVsTvS.js";import{M as le,u as re}from"./shared-ui-DksRfdM8.js";function ue(){const w=q(),{allSubmissions:S}=X(),[b,A]=c.useState([]),[C,i]=c.useState("All"),[f,k]=c.useState(null),[E,v]=c.useState(null),[P,_]=c.useState(!0),T=()=>{try{const a=f?b.filter(d=>d.id===f):h,n=[["Client","Month","KPI Score","Services"]];a.forEach(d=>{(S||[]).filter(x=>(x.clients||[]).some(g=>g.name===d.name)).forEach(x=>{var F;const g=((F=x.scores)==null?void 0:F.kpiScore)??"",y=(d.services||[]).map(I=>typeof I=="string"?I:I.service).join(";");n.push([d.name,x.monthKey,g,y])})});const m=n.map(d=>d.map(x=>`${x}`.replace(/"/g,'""')).map(x=>/[",\n]/.test(x)?`"${x}"`:x).join(",")).join(`
`),u=new Blob([m],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),r=URL.createObjectURL(u);o.href=r,o.download=`kpi-by-client-${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}catch(a){console.error("Export failed",a)}};c.useEffect(()=>{(async()=>{if(w)try{_(!0);const{data:n,error:m}=await w.from("clients").select("*").order("name");if(m)throw m;A(n||[])}catch(n){console.error("Error fetching clients:",n)}finally{_(!1)}})()},[w]);const D=c.useMemo(()=>{const a=new Set(["All"]);return b.forEach(n=>a.add(n.team||"Web")),Array.from(a)},[b]),h=c.useMemo(()=>C==="All"?b:b.filter(a=>a.team===C),[b,C]),M=c.useMemo(()=>h.map(a=>({label:a.name,value:a.id})),[h]),s=c.useMemo(()=>{if(!f)return null;const a=b.find(u=>u.id===f);if(!a)return null;const n=(S||[]).filter(u=>(u.clients||[]).some(o=>o.name===a.name)),m=n.length>0?n.reduce((u,o)=>o.monthKey>u.monthKey?o:u):null;return{client:a,submissions:n,latestMonthKey:(m==null?void 0:m.monthKey)||null}},[f,b,S]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("select",{className:"border rounded-xl p-2",value:C,onChange:a=>i(a.target.value),children:D.map(a=>e.jsx("option",{children:a},a))}),e.jsx("div",{className:"min-w-[240px]",children:e.jsx(le,{options:M,value:f?[f]:[],onChange:a=>k(a[0]||null),placeholder:"Select a client",single:!0})}),e.jsx("button",{className:"border rounded-xl px-3 py-2",onClick:T,children:"Export KPI by Client"})]}),P?e.jsx("div",{className:"text-gray-500",children:"Loading clients..."}):e.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:h.map(a=>{var n;return e.jsxs("div",{className:"border rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium",children:a.name}),e.jsx("button",{className:"rounded-xl px-3 py-2 border",onClick:()=>v(a),children:"Edit"})]}),e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:["Team: ",a.team]}),((n=a.services)==null?void 0:n.length)>0&&e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:["Services: ",a.services.map(m=>m.service).join(", ")]})]},a.id)})}),s&&e.jsxs("div",{className:"border rounded-xl p-4 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold",children:s.client.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Submissions: ",s.submissions.length]}),Array.isArray(s.client.services)&&s.client.services.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Service Scope Progress"}),e.jsx("div",{className:"space-y-2",children:(()=>{const a=s.client.services,n=a.reduce((m,u)=>{const o=typeof u=="string"?u:u.service,r=L(s.client,o,{monthKey:s.latestMonthKey})||0,d=O(o);return m+d*r},0)||1;return a.map((m,u)=>{const o=typeof m=="string"?m:m.service,r=L(s.client,o,{monthKey:s.latestMonthKey}),d=r==null?0:Math.max(0,Math.min(100,r)),x=O(o),g=Math.round(x*d/n*100);return e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsxs("span",{className:"font-medium",children:[o," ",e.jsxs("span",{className:"text-gray-500",children:["(w ",x,", ",g,"% of scope)"]})]}),e.jsxs("span",{className:"text-gray-600",children:[d,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`${d>=100?"bg-green-500":d>=60?"bg-yellow-500":"bg-red-500"} h-2 rounded-full`,style:{width:`${d}%`}})})]},u)})})()})]})]}),E&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl p-4 w-full max-w-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-lg font-medium",children:"Edit Client"}),e.jsx("button",{className:"text-gray-500",onClick:()=>v(null),children:"✕"})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-3 mt-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Client Name"}),e.jsx("input",{className:"w-full border rounded-xl p-2",value:E.name,onChange:a=>v(n=>({...n,name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Team"}),e.jsxs("select",{className:"w-full border rounded-xl p-2",value:E.team,onChange:a=>v(n=>({...n,team:a.target.value})),children:[e.jsx("option",{children:"Web"}),e.jsx("option",{children:"Marketing"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx("button",{className:"rounded-xl px-4 py-2 border",onClick:()=>v(null),children:"Cancel"}),e.jsx("button",{className:"rounded-xl px-4 py-2 bg-blue-600 text-white",onClick:()=>v(null),children:"Save"})]})]})})]})}const ce=[{value:"Standard",label:"Standard",description:"Basic service package"},{value:"Premium",label:"Premium",description:"Enhanced service package"},{value:"Enterprise",label:"Enterprise",description:"Full-service package"}],ie=[{value:"Web",label:"Web Team",description:"Website development, maintenance, and AI tools"},{value:"Marketing",label:"Marketing Team",description:"Website development and marketing services"},{value:"Website",label:"Website Team",description:"Website development only"}];function xe({onClientAdded:w,onCancel:S,compact:b=!1}){const A=q(),{notify:C}=re(),{user:i,role:f}=Z(),k=f,{addClient:E}=ee(),{addSystemNotification:v}=te(),[P,_]=c.useState(!1),[T,D]=c.useState(!1),[h,M]=c.useState(1),[s,a]=c.useState({...U,team:(i==null?void 0:i.department)||"Web"}),[n,m]=c.useState([]),[u,o]=c.useState({}),[r,d]=c.useState({}),x=c.useCallback(()=>{a({...U,team:(i==null?void 0:i.department)||"Web"}),m([]),o({}),d({}),M(1)},[i==null?void 0:i.department]),g=c.useCallback(t=>{const l={};return t===1&&(s.name.trim()||(l.name="Client name is required"),s.team||(l.team="Team selection is required"),s.client_type||(l.client_type="Client type is required")),t===2&&n.length===0&&(l.services="At least one service must be selected"),t===3&&(s.contact_email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.contact_email)&&(l.contact_email="Please enter a valid email address"),s.contact_phone&&!/^[\d\s\-\+\(\)]+$/.test(s.contact_phone)&&(l.contact_phone="Please enter a valid phone number")),d(l),Object.keys(l).length===0},[s,n]),y=c.useCallback((t,l)=>{a(p=>({...p,[t]:l})),r[t]&&d(p=>{const j={...p};return delete j[t],j})},[r]),F=c.useCallback(t=>{m(l=>{const p=l.includes(t),j=p?l.filter($=>$!==t):[...l,t];return p||o($=>({...$,[t]:W[t]||"Monthly"})),j}),r.services&&d(l=>{const p={...l};return delete p.services,p})},[r.services]),I=c.useCallback((t,l)=>{o(p=>({...p,[t]:l}))},[]),B=c.useCallback(()=>{g(h)&&M(t=>t+1)},[h,g]),V=c.useCallback(()=>{M(t=>t-1)},[]),Y=c.useCallback(async()=>{var t,l,p;if(g(3)){D(!0);try{const j=n.map(R=>({service:R,frequency:u[R]||W[R]||"Monthly",notes:"",added_date:new Date().toISOString()})),$={name:s.name.trim(),team:s.team,client_type:s.client_type,status:"Active",services:j,contact_email:((t=s.contact_email)==null?void 0:t.trim())||"",contact_phone:((l=s.contact_phone)==null?void 0:l.trim())||"",scope_notes:((p=s.scope_notes)==null?void 0:p.trim())||"",start_date:s.start_date||new Date().toISOString().split("T")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString(),created_by:(i==null?void 0:i.name)||"Unknown",created_by_role:k||"employee"},{data:N,error:K}=await A.from("clients").insert([$]).select().single();if(K)throw new Error(`Database error: ${K.message}`);E(N);const H={type:"success",priority:"medium",category:"client_management",title:"New Client Added",message:`${N.name} has been added to the ${N.team} team by ${(i==null?void 0:i.name)||"Unknown"} (${k||"employee"})`,dashboard:"all",metadata:{clientId:N.id,clientName:N.name,team:N.team,addedBy:(i==null?void 0:i.name)||"Unknown",addedByRole:k||"employee",services:n}};v(H),C({type:"success",title:"Client Added Successfully",message:`${N.name} has been added to the ${N.team} team`}),x(),_(!1),w&&w(N)}catch(j){console.error("Error creating client:",j),C({type:"error",title:"Failed to Add Client",message:j.message||"An unexpected error occurred"})}finally{D(!1)}}},[s,n,u,g,A,i,k,E,v,C,x,w]),Q=()=>e.jsx("div",{className:"flex items-center justify-center mb-6",children:[1,2,3].map(t=>e.jsxs(ne.Fragment,{children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium ${h>=t?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:t}),t<3&&e.jsx("div",{className:`w-12 h-1 mx-2 ${h>t?"bg-blue-600":"bg-gray-200"}`})]},t))}),z=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Basic Information"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Client Name *"}),e.jsx("input",{type:"text",value:s.name,onChange:t=>y("name",t.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${r.name?"border-red-300":"border-gray-300"}`,placeholder:"Enter client name"}),r.name&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:r.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Team *"}),e.jsx("select",{value:s.team,onChange:t=>y("team",t.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${r.team?"border-red-300":"border-gray-300"}`,children:ie.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),r.team&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:r.team})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Client Type *"}),e.jsx("div",{className:"grid grid-cols-1 gap-3",children:ce.map(t=>e.jsxs("label",{className:"flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"client_type",value:t.value,checked:s.client_type===t.value,onChange:l=>y("client_type",l.target.value),className:"mr-3 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.label}),e.jsx("div",{className:"text-sm text-gray-600",children:t.description})]})]},t.value))}),r.client_type&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:r.client_type})]})]}),J=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Services & Scope"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Services *"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 max-h-64 overflow-y-auto border rounded-lg p-3",children:se(s.team).map(t=>e.jsxs("label",{className:"flex items-start gap-3 p-2 hover:bg-gray-50 rounded",children:[e.jsx("input",{type:"checkbox",checked:n.includes(t),onChange:()=>F(t),className:"mt-1 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-sm text-gray-900",children:t}),n.includes(t)&&e.jsx("select",{value:u[t]||W[t]||"Monthly",onChange:l=>I(t,l.target.value),className:"mt-1 text-xs border border-gray-300 rounded px-2 py-1 w-full",children:ae.map(l=>e.jsx("option",{value:l,children:l},l))})]})]},t))}),r.services&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:r.services})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Scope Notes"}),e.jsx("textarea",{value:s.scope_notes,onChange:t=>y("scope_notes",t.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Describe the scope of work, special requirements, or notes..."})]})]}),G=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Contact Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Contact Email"}),e.jsx("input",{type:"email",value:s.contact_email,onChange:t=>y("contact_email",t.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${r.contact_email?"border-red-300":"border-gray-300"}`,placeholder:"client@example.com"}),r.contact_email&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:r.contact_email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Contact Phone"}),e.jsx("input",{type:"tel",value:s.contact_phone,onChange:t=>y("contact_phone",t.target.value),className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${r.contact_phone?"border-red-300":"border-gray-300"}`,placeholder:"+1 (555) 123-4567"}),r.contact_phone&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:r.contact_phone})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Start Date"}),e.jsx("input",{type:"date",value:s.start_date,onChange:t=>y("start_date",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mt-6",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"Summary"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Client:"})," ",s.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Team:"})," ",s.team]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",s.client_type]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Services:"})," ",n.join(", ")]}),s.contact_email&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Email:"})," ",s.contact_email]}),s.contact_phone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Phone:"})," ",s.contact_phone]})]})]})]});return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>_(!0),className:b?"w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2":"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"➕"}),"Add New Client"]}),P&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden relative",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Add New Client"}),e.jsx("button",{onClick:()=>{_(!1),x(),S&&S()},className:"text-gray-400 hover:text-gray-600 text-xl",children:"✕"})]}),Q()]}),e.jsxs("div",{className:"px-6 py-4 overflow-y-auto max-h-[60vh]",children:[h===1&&z(),h===2&&J(),h===3&&G()]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-between",children:[e.jsx("button",{onClick:h===1?()=>{_(!1),x(),S&&S()}:V,className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors",children:h===1?"Cancel":"Previous"}),h<3?e.jsx("button",{onClick:B,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Next"}):e.jsxs("button",{onClick:Y,disabled:T,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[T&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),T?"Adding Client...":"Add Client"]})]})]})})]})}export{xe as C,ue as a};
